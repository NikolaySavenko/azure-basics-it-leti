# Azure Functions

# Azure Serverless Functions

![Untitled](Azure%20Functions%20971234c2c9b84fab969f544938267263/Untitled.png)

В традиционном подходе основную логику системы выполняет монолитное приложение. И сервер с приложением запущен постоянно, даже если нагрузки нет.

**Serverless - это про избавление платы за бездействие!**

Это новый подход к построению систем в облаке, который имеет наибольшую эффективность именно в облаке.

### Идея

Идея в том, что логика приложения разбивается на независимые функции. Они имеют событийную структуру. Каждая из функций выполняет одну «микрозадачу»(не путать с микросервисом). Все, что требуется от разработчика ― загрузить функции в облако и соотнести их с источниками событий. Код будет исполняться по запросу в автоматически подготовленном экземпляре, а мы заплатим только за время исполнения.

Т.е. в случае Serverless, мы не имеем постоянно работающего экземпляра приложения, а имеем временный экземпляр, который подготавливается в момент возникновения нужного нам события, а затем, после выполнения кода, уничтожается.

Если у нас нет постоянно запущенного экземпляра, то за что мы платим?

### Оплата за количество выполнений и потребнение памяти.

## Почему это выгодно провайдеру?

Ему не нужно держать постоянно запущенный экземпляр приложения, а значит можно размещать их плотнее.

Ваше приложение будет работать только во время выполнения полезной нагрузки, а остальное время - спать.

## Параллельность

Надеюсь многие из вас уже знакомы с многопоточным выполением программы.

Почти во всех современных платформах используется модель распараллеливания на разные ядра и потоки процессора в рамках одной машины.

Но в случае с функциями Azure, в распараллеливании учавствует не одна машина, множество машин в облаке.

**Многопоточность на уровне множества машин.**

Это означает, что вместе с этими преимуществами мы получаем и некоторые ограничения - мы не можем использовать встроенные средства платформ(.NET, Java...) для управления потоками, вместо этого мы будем использовать средства, котрые нам предоставляются Azure Functions SDK.

Когда я только начинал использовать функции Azure, я не знал, что не следует использовать встроенные средства управления потоками и, несмотря на то, что код был написан хорошо, выполнялся он крайне неэффективно

![Untitled](Azure%20Functions%20971234c2c9b84fab969f544938267263/Untitled%201.png)

## Event-Driven

Функции идеально подходят для постоения арихтектуры на основе событий!

Самый популярный пример Event-Driven это IoT. 

Допустим мы имеем умную лампочку и выключатель. Прекрасный пример для применения архитектуры на основе событий. Мы имеем четкое событие - нажатие на выключатель и мы имеем четкую реакцию - переключение света. Наше приложение будет полезно только в момент наступления события.

Примеров таких событий может быть много: наступление 9 утра, нажатие по кнопке на сайте, приходи письма по почте, запись в базу данных и т.д.

Нам нужно только настроиться на нужные события и выполнять функции только во время их нступления.

![Untitled](Azure%20Functions%20971234c2c9b84fab969f544938267263/Untitled%202.png)

## Triggers

Такие события в терминах Azure Functions называются триггерами. Их очень много.

При создании функции мы заранее указываем триггер по которому она будет вызвана, а так же указываем параметры этого триггера. 

Например функция должна вызываться каждый час. Тогда мы используем TimerTrigger и в качестве параметра передаем CRON.

Или же мы просто делаем сервис с API - тогда мы делаем HTTP триггер и передаем ему имя конечной точки

![Untitled](Azure%20Functions%20971234c2c9b84fab969f544938267263/Untitled%203.png)

![Untitled](Azure%20Functions%20971234c2c9b84fab969f544938267263/Untitled%204.png)

# Bindings

Отлично, мы научились запускать наши функции, а теперь нам нужно оперировать данными. 

Для этого используются Binding.  Они позволяют нам либо получать данные из внешних источников, либо записывать их куда-либо.

В соответствии с этим Bindings бывают input и output

Например: наша функция сработала по триггеру HTTP, а в качестве ответа мы хотим вернуть данные из базы данных Cosmos DB. Для этого укажем, что функция использует выходной Binding CosmosDB.

![Untitled](Azure%20Functions%20971234c2c9b84fab969f544938267263/Untitled%205.png)

![Untitled](Azure%20Functions%20971234c2c9b84fab969f544938267263/Untitled%206.png)

# Как приложение узнает, какие Bindings нам нужны?

Для этого используется function.json файл, в котором мы прописываем нужные биндинги и триггеры. Такой файл создается для каждой функции.

Вот пример из случайного проекта на GitHub, в котором функции написаны на python

![Untitled](Azure%20Functions%20971234c2c9b84fab969f544938267263/Untitled%207.png)

![Untitled](Azure%20Functions%20971234c2c9b84fab969f544938267263/Untitled%208.png)

К счастью для тех, кто пишет на .NET и возможно Java, этот файл будет создаваться автоматически и его не нужно писать самому.

# Поддерживаемые платформы

![Untitled](Azure%20Functions%20971234c2c9b84fab969f544938267263/Untitled%209.png)

1.Linux является единственной поддерживаемой операционной системой для стека среды выполнения Python.

2.поддержка PowerShell в Linux в настоящее время доступна в предварительной версии.

3.Linux — единственная поддерживаемая операционная система для контейнеров Docker.

Среда службы приложений (ASE) — это компонент Службы приложений Azure, предоставляющий полностью изолированную и выделенную среду для безопасного выполнения приложений Службы приложений в большом масштабе.

# Выставление счетов

![Untitled](Azure%20Functions%20971234c2c9b84fab969f544938267263/Untitled%2010.png)

# Перед началом

Что нам потребуется?

- IDE (VS предпочтительна, но можно и на JetBrains, но придется поставить плагин)
- Azure Functions Core Tools