# Виртуальные машины

[Виртуальные машины.pptx](%D0%92%D0%B8%D1%80%D1%82%D1%83%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5%20%D0%BC%D0%B0%D1%88%D0%B8%D0%BD%D1%8B%20676149d2d63541f499e0fc54b4177f00/%D0%92%D0%B8%D1%80%D1%82%D1%83%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5_%D0%BC%D0%B0%D1%88%D0%B8%D0%BD%D1%8B.pptx)

# Classic VM

Как и все облка, Azure предоставляет нам возможность арендовать полноценную виртуальную машину. Тот самый IaaS с первой лекции.

Представьте, что вы работаете в компании, которая занимается обработкой видеоданных и анализом шаблонов. Вы создаете новый прототип платформы для обработки видео с дорожных камер, анализа тенденций и предоставления полезных данных для улучшения трафика и дорог.

Чтобы улучшить свои алгоритмы, вы договорились с несколькими новыми городами о сборе данных с их дорожных камер. Однако не все видеоданные имеют один формат, а многие форматы поддерживают только кодеки Windows для декодирования данных. Поэтому вы решили использовать виртуальные машины для выполнения начальной обработки, после чего данные будут отправляться в службу "Функции Azure", которая выполнит обработку в стандартном формате. Такой подход позволит вам использовать новые форматы данных динамически без остановки работы всей системы.

![Untitled](%D0%92%D0%B8%D1%80%D1%82%D1%83%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5%20%D0%BC%D0%B0%D1%88%D0%B8%D0%BD%D1%8B%20676149d2d63541f499e0fc54b4177f00/Untitled.png)

Виртуальные машины Azure — это масштабируемые облачные вычислительные ресурсы по требованию. Они аналогичны виртуальным машинам, размещенным в Windows Hyper-V. У них есть процессор, память, хранилище и сетевые ресурсы. Вы можете запускать и останавливать виртуальные машины по желанию, как и в Hyper-V, и управлять ими на портале Azure или с помощью Azure CLI. Вы также можете использовать клиент протокола удаленного рабочего стола (RDP), чтобы подключиться напрямую к пользовательскому интерфейсу рабочего стола Windows и использовать виртуальную машину, как если бы она была локальным компьютером Windows

## ****Создание виртуальной машины Azure****

Виртуальные машины можно определять и развертывать в Azure несколькими способами: с помощью портала Azure, с помощью сценария (с использованием Azure CLI или Azure PowerShell) или на основе шаблона Azure Resource Manager. В любом случае необходимо указать некоторые данные, которые мы вкратце рассмотрим.

В Azure Marketplace также предлагаются предварительно настроенные образы, которые включают в себя как операционную систему, так и популярные программные средства для определенных сценариев.

![Untitled](%D0%92%D0%B8%D1%80%D1%82%D1%83%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5%20%D0%BC%D0%B0%D1%88%D0%B8%D0%BD%D1%8B%20676149d2d63541f499e0fc54b4177f00/Untitled%201.png)

## ****Ресурсы, используемые на виртуальной машине Windows****

При создании виртуальной машины Windows в Azure вы также создаете ресурсы для размещения виртуальной машины. Вместе они служат для виртуализации компьютера и выполнения операционной системы Windows. Ресурсы должны либо уже существовать (и выбираться при создании виртуальной машины), либо создаваться вместе с виртуальной машиной.

- Виртуальная машина, предоставляющая ресурсы ЦП и памяти.
- Учетная запись хранения Azure для размещения виртуальных жестких дисков.
- Виртуальные диски для хранения операционной системы, приложений и данных.
- Виртуальная сеть для подключения виртуальной машины к другим службам Azure или вашему локальному оборудованию.
- Сетевой интерфейс для взаимодействия с виртуальной сетью.
- Общедоступный IP-адрес для доступа к виртуальной машине. Это необязательно.

Как и для других служб Azure, вам потребуется **группа ресурсов**, в которой будет содержаться виртуальная машина. Она также может применяться для объединения ресурсов с целью администрирования. При создании виртуальной машины вы можете выбрать существующую группу ресурсов или создать новую.

## ****Выбор образа виртуальной машины****

Выбор образа является одним из первых и самых важных решений, принимаемых при создании виртуальной машины. Образ — это шаблон, используемый для создания виртуальной машины. Эти шаблоны уже содержат операционную систему и часто другое программное обеспечение, такое как средства разработки или среды размещения веб-сайтов.

В образ виртуальной машины можно добавить любое приложение, поддерживаемое компьютером. Виртуальную машину можно создать из образа, настроенного для решения именно ваших задач, например для размещения приложения [ASP.Net](http://asp.net/) Core.

## ****Определение размера виртуальной машины****

У виртуальной машины есть определенный объем памяти и мощность ЦП, как и у физического компьютера. Azure предлагает виртуальные машины разных размеров и по разным ценам. Выбранный размер определяет вычислительную мощность, объем памяти и хранилища виртуальных машин.

Размеры виртуальных машин сгруппированы по категориям, начиная с серии B для простейшего тестирования и заканчивая серией H для сложных вычислительных задач. Размер виртуальной машины следует выбирать в соответствии с требуемой рабочей нагрузкой. Размер виртуальной машины можно изменить после создания, но для этого необходимо сначала завершить ее работу, поэтому лучше сразу выбрать правильный размер, если это возможно.

### **Ниже приведены несколько рекомендаций для различных сценариев.**

[Размеры машин](%D0%92%D0%B8%D1%80%D1%82%D1%83%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5%20%D0%BC%D0%B0%D1%88%D0%B8%D0%BD%D1%8B%20676149d2d63541f499e0fc54b4177f00/%D0%A0%D0%B0%D0%B7%D0%BC%D0%B5%D1%80%D1%8B%20%D0%BC%D0%B0%D1%88%D0%B8%D0%BD%20a9653fc80bcd4114a7d4d2b90fb9fa21.csv)

## **Выбор вариантов хранения**

Следующие решения связаны с хранилищем. Во-первых, вы можете выбрать технологию дисков. Доступные варианты включают жесткие диски (HDD) или более современные твердотельные накопители (SSD). Так же как и в случае с физическим оборудованием, диски SSD дороже, но эффективнее.

### **Неуправляемые и управляемые диски**

Последнее решение, которое нужно принять в отношении хранилища, — следует ли использовать **неуправляемые** или **управляемые** диски.

В случае с неуправляемыми дисками вы отвечаете за учетные записи хранения, используемые для хранения виртуальных жестких дисков, которые соответствуют дискам виртуальной машины. Вы оплачиваете используемое пространство по ставкам, установленным для учетной записи хранения. Для отдельной учетной записи хранения установлен фиксированный предел скорости, равный 20 000 операций ввода-вывода в секунду. Это означает, что одна учетная запись хранения поддерживает максимум 40 стандартных виртуальных жестких дисков. Если необходимо выполнить горизонтальное масштабирование, потребуются дополнительные учетные записи хранения, что может создать сложности.

Более новой, рекомендуемой моделью дискового хранилища являются управляемые диски. Они изящно решают проблему увеличения сложности, перекладывая задачи управления учетными записями хранения на Azure. Вам нужно выбрать тип ("Премиум" или "Стандартный") и размер диска, а Azure создаст диск и будет управлять им *и* соответствующим хранилищем. Вам не нужно беспокоиться об ограничениях учетной записи хранения, что упрощает горизонтальное масштабирование. Кроме того, есть ряд других преимуществ.

- **Повышенная надежность**. Azure размещает виртуальные жесткие диски, связанные с высоконадежными виртуальными машинами, в разных частях службы хранилища Azure, чтобы обеспечить приблизительно одинаковый уровень устойчивости.
- **Улучшенная безопасность**. Управляемые диски представляют собой настоящие управляемые ресурсы в группе ресурсов. Это означает, что они могут использовать управление доступом на основе ролей для ограничения доступа к данным на виртуальных жестких дисках.
- **Поддержка моментальных снимков**. С помощью моментальных снимков можно создавать копии виртуального жесткого диска, доступные только для чтения. Для этого необходимо завершить работу виртуальной машины, но на само создание снимка уходит всего несколько секунд. По завершении вы можете включить виртуальную машину и с помощью моментального снимка создать ее копию для устранения неполадок или отката виртуальной машины к состоянию на момент создания моментального снимка.
- **Поддержка резервного копирования**. С помощью службы Azure Backup можно автоматически создавать резервные копии управляемых дисков в разных регионах для обеспечения аварийного восстановления, не прерывая работу виртуальной машины.

## **Взаимодействие по сети**

Виртуальные машины взаимодействуют с внешними ресурсами по виртуальной сети. Виртуальная сеть представляет собой частную сеть в одном регионе, с которой взаимодействуют ресурсы. Управлять виртуальной сетью можно так же, как локальной. Ее можно разделять на подсети, чтобы изолировать ресурсы, подключать к другим сетям (в том числе локальным) и применять правила трафика для управления входящими и исходящими подключениями.

### **Планирование сети**

При создании виртуальной машины можно выбрать существующую виртуальную сеть в вашем регионе или создать новую.

Создание сети вместе с виртуальной машиной — простейший вариант, но он не идеален в большинстве ситуаций. Лучше *заранее* спланировать требования к сети для всех компонентов архитектуры и создать структуру виртуальной сети отдельно. Затем создайте виртуальные машины и поместите их в уже созданные виртуальные сети.

## ****Подключение к виртуальным машинам Microsoft Azure через протокол удаленного рабочего стола****

Теперь, когда у нас есть виртуальная машина Windows в Azure, необходимо разместить в ней приложения и данные для обработки видеотрафика.

Однако, если вы не настроили подключение VPN между сайтами в Azure, ваши виртуальные машины Azure будут недоступны из локальной сети. Если вы только начинаете работу с Azure, вряд ли у вас есть налаженное подключение VPN между сайтами. Как же передать файлы в виртуальные машины Azure? Один из самых простых способов — воспользоваться функцией подключения к удаленному рабочему столу в Azure, чтобы предоставить новым виртуальным машинам Azure доступ к локальным дискам.

На новую виртуальную машину Windows необходимо установить пользовательское программное обеспечение. Существует несколько вариантов выбора.

- Протокол удаленного рабочего стола (RDP)
- пользовательские скрипты;
- пользовательские образы виртуальных машин (с предустановленным программным обеспечением).

Рассмотрим самый простой подход для виртуальных машин Windows — удаленный рабочий стол

## **Что такое протокол удаленного рабочего стола?**

Протокол удаленного рабочего стола (RDP) обеспечивает удаленное подключение к пользовательскому интерфейсу компьютеров Windows. RDP позволяет входить в систему удаленного физического или виртуального компьютера Windows и контролировать этот компьютер так, как если бы вы использовали консоль. RDP-подключение позволяет реализовывать большинство операций, которые можно выполнять с консоли физического компьютера, за исключением некоторых функций, связанных с электропитанием и оборудованием.

Для подключения по протоколу RDP требуется клиент RDP. Корпорация Майкрософт предоставляет клиенты RDP для следующих операционных систем:

- Windows (встроенный);
- macOS;
- iOS
- Android.

![Untitled](%D0%92%D0%B8%D1%80%D1%82%D1%83%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5%20%D0%BC%D0%B0%D1%88%D0%B8%D0%BD%D1%8B%20676149d2d63541f499e0fc54b4177f00/Untitled%202.png)

Кроме того, подключаться к ПК Windows позволяют некоторые клиенты Linux с открытым исходным кодом из дистрибутива Ubuntu, например Remmina.

## **Подключение к виртуальной машине Azure**

Как мы недавно увидели, виртуальные машины Azure обмениваются данными в виртуальной сети. Им также могут быть назначены необязательные общедоступные IP-адреса. С помощью общедоступного IP-адреса можно взаимодействовать с виртуальной машиной через Интернет. Кроме того, можно настроить виртуальную частную сеть (VPN), соединяющую локальную сеть с Azure. Это позволит безопасно подключаться к виртуальной машине, не предоставляя общедоступный IP-адрес. Такой подход рассматривается в другом модуле. Полную информацию о нем можно найти в документации.

Одна из особенностей общедоступных IP-адресов в Azure, которую следует учитывать, заключается в том, что они часто выделяются динамически. Это значит, что IP-адрес со временем может меняться. Для виртуальных машин это происходит при их перезапуске. За дополнительную плату можно назначить статические адреса, если необходимо подключаться непосредственно по IP-адресу, а не по имени, и IP-адрес не изменится.

### **Как осуществляется подключение к виртуальной машине в Azure с помощью протокола RDP?**

Подключиться к виртуальной машине в Azure с помощью протокола RDP очень просто. На портале Azure перейдите в раздел свойств виртуальной машины и в верхней части экрана щелкните **Подключить**. Вы увидите IP-адреса, назначенные виртуальной машине, и сможете скачать **предварительно настроенный файл RDP**, который система Windows откроет в клиенте RDP. Вы можете подключиться через общедоступный IP-адрес виртуальной машины в RDP-файле. Вместо этого при подключении через VPN внутренний IP-адрес. Можно также выбрать номер порта для подключения.

Если для виртуальной машины вы используете статический общедоступный IP-адрес, сохраните файл **.rdp** на рабочем столе. Если вы используете динамическую IP-адресацию, файл **.rdp** будет действительным, только пока виртуальная машина находится в рабочем режиме. В случае остановки и перезапуска виртуальной машины потребуется скачать другой файл **.rdp**.

## Spot Instance

В русском переводе их обычно называют точечными.

Это особый тип, который поддерживает политику вытеснения, иными словами, машины смогут автоматически включаться и выключаться при определенных условиях, это бывает очень полезно для экономии средств.

![Untitled](%D0%92%D0%B8%D1%80%D1%82%D1%83%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5%20%D0%BC%D0%B0%D1%88%D0%B8%D0%BD%D1%8B%20676149d2d63541f499e0fc54b4177f00/Untitled%203.png)

Это означает, что точечные виртуальные машины Azure прекрасно подходят для рабочих нагрузок, для которых допустимы прерывания, например для заданий пакетной обработки, сред разработки или тестирования, больших вычислительных рабочих нагрузок и др

![Untitled](%D0%92%D0%B8%D1%80%D1%82%D1%83%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5%20%D0%BC%D0%B0%D1%88%D0%B8%D0%BD%D1%8B%20676149d2d63541f499e0fc54b4177f00/Untitled%204.png)

[Политики вытеснения](%D0%92%D0%B8%D1%80%D1%82%D1%83%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5%20%D0%BC%D0%B0%D1%88%D0%B8%D0%BD%D1%8B%20676149d2d63541f499e0fc54b4177f00/%D0%9F%D0%BE%D0%BB%D0%B8%D1%82%D0%B8%D0%BA%D0%B8%20%D0%B2%D1%8B%D1%82%D0%B5%D1%81%D0%BD%D0%B5%D0%BD%D0%B8%D1%8F%20fe9023daf67f4517a9e0907d861f67e3.csv)

# Масштstuбируемые наборы виртуальных машин

Масштабируемые наборы виртуальных машин Azure позволяют создавать и администрировать группы виртуальных машин с балансировкой нагрузки. Число экземпляров виртуальных машин может автоматически увеличиваться или уменьшаться в зависимости от спроса или по определенному расписанию. Масштабируемые наборы предоставляют ряд таких основных преимуществ:

- Простота создания множества виртуальных машин и управления ими
- Обеспечивает высокую доступность и устойчивость приложений за счет распределения виртуальных машин между зонами доступности или доменами сбоя.
- При изменении спроса на ресурсы приложение может автоматически масштабироваться
- Поддержка работы в большом масштабе

Благодаря гибкой оркестрации Azure предоставляет унифицированный интерфейс экосистемы виртуальных машин Azure. Гибкая оркестрация предлагает гарантии высокого уровня доступности (до 1000 виртуальных машин), распределяя виртуальные машины между доменами сбоя в регионе или в зоне доступности. Это позволяет масштабировать приложение, сохраняя изоляцию доменов сбоя, которая необходима для выполнения рабочих нагрузок на основе кворума или с отслеживанием состояния, в том числе для следующих:

- Рабочие нагрузки на основе кворума
- Базы данных с открытым кодом
- Приложения с отслеживанием состояния
- Службы, требующие высокой доступности и масштабирования
- Службы, которые собираются сочетать типы ВМ разных типов или использовать точечные виртуальные машины и ВМ по запросу
- Существующие приложения группы доступности